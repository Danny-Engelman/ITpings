<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ITpings Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <script language="JavaScript">

    </script>
    <style>
        body {
            font-family: Helvetica Neue, Arial, sans-serif;
            font-size: 12px;
            color: #444;
        }

        table {
            border: 1px solid #42b983;
        }

        th {
            background-color: #42b983;
            color: rgba(255, 255, 255, 0.66);
        }

        td {
            background-color: #f9f9f9;
            text-align: center;
        }

        th, td {
            min-width: 80px;
        }

        [data-column='payload_raw'],
        [data-column='downlink_url'] {
            display: none;
        }

        .chart {
            max-height: 50vh;
            position: relative;
        }

        .chart_interval {
            position: absolute;
            top: 2px;
            right: 2px;
        }

        .chart_interval > div {
            border: 1px solid grey;
            width: 2.1em;
            margin-right: 1px;
            text-align: center;
            position: relative;
            float: left;
            font-size: 10px;
        }

        .chart_interval > div:hover {
            cursor: pointer;
            background-color: green;
            color: white;
        }
    </style>
</head>
<body>
<div id="Dashboard">
    <div class="chart" id="chart_temperature">
        <canvas id="myChart" width="400" height="400"></canvas>
        <div class="chart_interval"></div>
    </div>
    <itpings-chart></itpings-chart>
    <hr>
    <div class="grid">
        <div class="col-1-3">
            <itpings-table data-query="devices"></itpings-table>
            <itpings-table data-query="applications"></itpings-table>
            <itpings-table data-query="gateways"></itpings-table>
        </div>
        <div class="col-1-3">
            <div data-query="pingedgateways"></div>
            <div data-query="sensorvalues"></div>
            <div data-query="sensors"></div>
        </div>
        <div class="col-1-3">
            <div data-query="pings"></div>
            <div data-query="application_devices"></div>
        </div>
    </div>
</div>
<script language="JavaScript" data-customelement="itp-table">
    (function (thisDoc, elementName = 'itpings-table') {
//region ------------------------------------------------------------------------------------- ### globals & prototypes

        const __ATTR_data_query = 'data-query';

        let __log = (a, b, c) => console.log(`%cWC:${elementName}:`, 'background:lightgreen', a || '', b || '', c || '');
//endregion -------------------------------------------------------------------------------------- globals & prototypes

//region ------------------------------------------------------------------------------------- ### Classes

//endregion -------------------------------------------------------------------------------------- Classes

        window.customElements.define(elementName, class extends HTMLElement {

            //region ------------------------------------------------------------------------------------- ### WebComponent INIT

            static get observedAttributes() {                       /* HTML tag attributes this WebComponent listen to */
                console.warn('initiated observedAttributes');
                return [__ATTR_data_query];
            }

            constructor() {                                         /* WebComponent Constructor */
                super();
                __log('constructor');
            }

            attributeChangedCallback(attr, oldValue, newValue) {    /* dataAttributes changes */
                __log('attributeChanged', attr, oldValue, newValue);
                if (attr === __ATTR_data_query) {
                    let uri = location.href.split('/');
                    uri.pop();
                    uri.push('ITpings_connector.php?query=' + newValue);
                    uri = uri.join('/');
                    fetch(uri)
                        .then(response => response.json())
                        .then(json => {
                                // Create HTML TABLE, for a challenge refactor this to one .reduceRight call
                                let headers = [], maxid = 0;// maximum Primary Key value read in this DB response
                                // process rows first because the headers info is needed in the THEAD
                                let TBODY = json.map(function (row) {
                                    headers = Object.keys(row);
                                    let TRdata = '';// stuff all data values as data-attributes on the TR tag
                                    let TR = headers.map(function (columnName) {
                                        let value = row[columnName];
                                        if (columnName.indexOf('_') === 0) {// its a database primary _key
                                            if (value > maxid) maxid = value;
                                        }
                                        let data = ' data-' + columnName + '="' + value + '"';
                                        TRdata += data;
                                        return '<TD data-column="' + columnName + '" ' + data + '>' + value + '</TD>';
                                    }).join('');
                                    return '<TR' + TRdata + '>' + TR + '</TR>';
                                }).join('');

                                this.innerHTML = '<TABLE data-query="' + uri + '" data-maxid=' + maxid + '><THEAD><TR>'
                                    + headers.map(function (columnName) {
                                        return '<TH data-column="' + columnName + '">' + columnName + '</TH>';
                                    }).join('') + '</TR></THEAD>' + TBODY + '</TABLE>';

                                setTimeout(function () {
                                    window.me = this;
                                    var TABLE = this.firstChild;
                                    let maxid = TABLE.getAttribute('data-maxid');
                                    let uri = TABLE.getAttribute('data-query');
                                    console.log(maxid, uri, this);
                                }.bind(this), 100);
                            }
                        );
                }
            }

            connectedCallback() {                                   /* WebComponent is added to main DOM */
                __log('connected');
            }

//endregion -------------------------------------------------------------------------------------- WebComponent INIT

//region ------------------------------------------------------------------------------------- ### WebComponent METHODS


//endregion -------------------------------------------------------------------------------------- WebComponent METHODS

        });
    })(document.currentScript.ownerDocument); //webcomponent has its own DOM
</script>

<script>
    !function (window, document, config) {
        window.ITpings = window.ITpings || {};
        var IT = window.ITpings;

        var heartbeat = 100000;//10seconds

        class ITpingsdata {
            fetchData(uri, callback) {
                return fetch(uri).then(function (response) {
                    return response.json();
                }).then(callback);
            }

            constructor(query) {
                fetchData(config.host + 'query=' + query, function (data) {

                });
            }
        }

        function addChartIntervals(chartdiv) {

            var chart_intervals = [{
                label: '5m',
                interval: 5,
                intervalunit: 'MINUTE'
            }, {
                label: '30m',
                interval: 30,
                intervalunit: 'MINUTE'
            }, {
                label: '2H',
                interval: 2,
                intervalunit: 'HOUR'
            }, {
                label: '6H',
                interval: 6,
                intervalunit: 'HOUR'
            }, {
                label: '1D',
                interval: 1,
                intervalunit: 'DAY'
            }, {
                label: '2D',
                interval: 2,
                intervalunit: 'DAY'
            }, {
                label: '2W',
                interval: 2,
                intervalunit: 'WEEK'
            }, {
                label: '1M',
                interval: 1,
                intervalunit: 'MONTH'
            }, {
                label: '6M',
                interval: 6,
                intervalunit: 'MONTH'
            }, {
                label: '1Y',
                interval: 1,
                intervalunit: 'YEAR'
            }];

            var fragment = document.createDocumentFragment();
            chart_intervals.map(function (interval) {
                var DIV = document.createElement('DIV');
                DIV.innerHTML = interval.label;
                DIV.setAttribute('data-label', interval.label);
                DIV.addEventListener('click', function () {
                    alert(this.interval + this.intervalunit);
                }.bind(interval));
                fragment.appendChild(DIV);
            });
            var el = document.querySelector(".chart_interval");
            el.appendChild(fragment);
        }

        function initDashboard() {
            addChartIntervals('myChart');
            // document.querySelectorAll("[data-query]").forEach(function (div) {
            //     var query = div.getAttribute('data-query');
            //     var uri = host + 'query=' + query;
            //     //+ "&" + location.search.split('?')[1];// append all query parameters
            //     fetchData(uri, function (data) {
            //         div.innerHTML = JSON2HTML(data, query);
            //         console.info(query);
            //     });
            //
            // });
        }

        function updateTable() {
            //get last id from TABLE
            //get query from
            //query API for anything higher
            //count X new rows
            //while array elements
            //get last array element
            //add to top of TABLE/TBODY
            //delete last row from TABLE/TBODY

        }

        initDashboard();
        setInterval(function () {
            //initDashboard();
        }, heartbeat);

    }(window, document, {
        host: 'http://365csi.nl/itpings.nl/ITpings_connector.php?'
    });

</script>
</body>
</html>